import React, { useEffect, useContext, useState } from "react"
import { AnimationContext } from "../../contexts/animationContext"
import FontFaceObserver from "fontfaceobserver"
import imagesLoaded from "imagesloaded"
import anime from "animejs"

const Loaded = ({ children }) => {
  const [loadedCanGo, setLoadedCanGo] = useState(false)
  const [loadedStart, setLoadedStart] = useState(false)
  const { setAnimationsCanRuns } = useContext(AnimationContext)

  useEffect(() => {
    const font = new FontFaceObserver("Garbata-Regular")
    const fontTwo = new FontFaceObserver("Geomanist")
    const fontThree = new FontFaceObserver("TimesNewRoman-Italic")
    const imgLoaded = imagesLoaded(
      document.querySelector("body"),
      { background: true },
      null
    )

    Promise.all([
      window.loadPromise,
      font.load(null, 5000),
      fontTwo.load(null, 5000),
      fontThree.load(null, 5000),
      imgLoaded.on("done"),
    ]).then(function () {
      const diff = performance.now() - loadedStart > 300 ? 0 : 300

      setTimeout(() => {
        setLoadedCanGo(true)
      }, 300 + diff)

      setTimeout(() => {
        setAnimationsCanRuns(true)
      }, 1800 + diff)
    })
  }, [setAnimationsCanRuns, loadedStart])

  useEffect(() => {
    if (loadedCanGo) {
      anime
        .timeline({
          duration: 700,
          easing: "easeOutSine",
          complete: () => {
            document.querySelector("body").style.overflowY = "unset"
            anime.set(".loaded", {
              display: "none",
            })
          },
        })
        .add({
          targets: ".loaded__wrapper svg",
          translateY: "-100%",
        })
        .add({
          targets: ".loaded",
          translateY: "-100%",
        })
    }
  }, [loadedCanGo])

  useEffect(() => {
    setLoadedStart(performance.now())
    anime({
      targets: ".loaded__wrapper svg",
      duration: 350,
      translateY: ["110%", 0],
      easing: "easeOutSine",
      begin: () => (document.querySelector("body").style.overflow = "hidden"),
    })
  }, [])

  return (
    <>
      <div className="loaded">
        <div className="loaded__wrapper">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="1144.36"
            height="131.48"
            viewBox="0 0 1144.36 131.48"
          >
            <g transform="translate(-386.848 -464.344)">
              <path
                d="M76.912-58.064Q97.584-10.488,102.752,0h-19.3q-5.016-12.16-9.424-23.864L72.352-28.12q-7.9-.152-23.712-.152t-23.712.152Q18.544-12.16,14.136,0H-.152L6.232-14.9q3.344-8.056,15.124-35.872t20.292-49.1a3.974,3.974,0,0,1-2.736-2.28,6.85,6.85,0,0,1-.76-4.256H52.9q2.736,0,3.5,1.672ZM68.7-38.608,60.04-59.584q-.76-1.976-5.092-12.236t-6.46-16.8Q44.08-75.848,34.5-52.592,28.88-39.064,28.728-38.608Z"
                transform="translate(387 594)"
                fill="#141414"
              />
              <path
                d="M79.04,0Q77.824-2.736,68.4-18.316t-12.92-20.9q-1.824.152-5.32.152H29.032q0,32.072.3,39.064H13.376q.3-8.208.3-47.12,0-52.9-.3-59.28H48.032q14.136,0,24.168,4.332T87.4-89.984a31.579,31.579,0,0,1,5.168,17.936A30.162,30.162,0,0,1,86.792-53.5q-5.776,7.752-16.568,11.4Q76-32.68,85.348-17.708T96.824,0ZM48.792-49.1q13.224,0,20.368-5.548T76.3-71.136q0-12.008-7.448-18.24T47.272-95.608H36.024A15.385,15.385,0,0,0,30.856-95a2.923,2.923,0,0,0-1.824,2.432v42.1A47.176,47.176,0,0,0,41.04-49.1Z"
                transform="translate(490 594)"
                fill="#141414"
              />
              <path
                d="M10.032,0,18.7-106.4H30.7q3.8,0,5.016,2.736l30.4,63.688,30.856-63.688a5.461,5.461,0,0,1,1.444-2.052,3.626,3.626,0,0,1,2.356-.684h12.616L122.056,0H106.1L99.1-85.272,68.7-21.28q-1.52,2.432-3.648,2.432a3.6,3.6,0,0,1-2.28-.608A10.157,10.157,0,0,1,61.1-21.28L29.64-86.184,22.192,0Z"
                transform="translate(589 594)"
                fill="#141414"
              />
              <path
                d="M76.912-58.064Q97.584-10.488,102.752,0h-19.3q-5.016-12.16-9.424-23.864L72.352-28.12q-7.9-.152-23.712-.152t-23.712.152Q18.544-12.16,14.136,0H-.152L6.232-14.9q3.344-8.056,15.124-35.872t20.292-49.1a3.974,3.974,0,0,1-2.736-2.28,6.85,6.85,0,0,1-.76-4.256H52.9q2.736,0,3.5,1.672ZM68.7-38.608,60.04-59.584q-.76-1.976-5.092-12.236t-6.46-16.8Q44.08-75.848,34.5-52.592,28.88-39.064,28.728-38.608Z"
                transform="translate(721 594)"
                fill="#141414"
              />
              <path
                d="M100.168-106.4q-.3,12.464-.3,70.072,0,32.68.152,36.328h-7.9a5.7,5.7,0,0,1-2.356-.3,10.8,10.8,0,0,1-1.9-1.824Q70.072-26.144,37.392-67.184L25.08-82.84l-.152,36.784q0,35.72.3,46.056H13.376q.3-5.168.3-53.96,0-48.336-.3-52.44h8.056a9.351,9.351,0,0,1,2.66.3,3.951,3.951,0,0,1,1.9,1.52Q36.936-89.528,51.6-70.756t28.8,36.4l8.208,10.336q0-74.176-.456-82.384Z"
                transform="translate(824 594)"
                fill="#141414"
              />
              <path
                d="M51.68-106.4a58.328,58.328,0,0,1,27.892,6.688A50.341,50.341,0,0,1,99.408-80.864a53.005,53.005,0,0,1,7.3,27.816q0,16.112-6.84,28.12A46.4,46.4,0,0,1,80.712-6.46Q68.4,0,52.592,0H13.376q.456-4.864.456-47.424,0-52.136-.456-58.976ZM54.568-9.88A34.843,34.843,0,0,0,72.58-14.668,33.739,33.739,0,0,0,85.5-28.8q4.788-9.348,4.788-22.116,0-13.832-5.852-24.168A41.92,41.92,0,0,0,69.16-90.972,38.911,38.911,0,0,0,49.1-96.52H36.176a23.893,23.893,0,0,0-5.32.38,1.845,1.845,0,0,0-1.52,1.6q-.152,10.184-.152,40.736,0,30.4.152,40.888a30.237,30.237,0,0,0,6,2.28,28.747,28.747,0,0,0,7.068.76Z"
                transform="translate(938 594)"
                fill="#141414"
              />
              <path
                d="M83.144,1.824A64.713,64.713,0,0,1,62.852-1.292q-9.5-3.116-15.2-8.36t-5.7-11.324a8.367,8.367,0,0,1,3.8-7.22,15.5,15.5,0,0,1,9.12-2.66,22.982,22.982,0,0,1,3.04.152q3.5,11.4,9.652,16.872T84.816-8.36q10.488,0,17.328-4.56t6.84-13.984a14.3,14.3,0,0,0-3.5-9.956,23.215,23.215,0,0,0-9.728-6.08A133.255,133.255,0,0,0,79.5-47.272a104.574,104.574,0,0,1-19.684-5.852A30.087,30.087,0,0,1,47.2-62.776Q42.56-69.008,42.56-78.888q0-13.68,10.792-21.432t27.816-7.752a55.656,55.656,0,0,1,18.392,3.116,39.228,39.228,0,0,1,14.516,8.436q5.548,5.32,5.548,11.248a7.626,7.626,0,0,1-2.888,6.46,12.465,12.465,0,0,1-7.752,2.2q-1.064,0-3.8-.3Q101.992-87.7,95.532-92.8t-16.34-5.092A24.573,24.573,0,0,0,64.448-93.4q-6.232,4.484-6.232,12.692,0,8.968,8.132,13.68t23.028,7.448a100.16,100.16,0,0,1,18.012,4.94,28.8,28.8,0,0,1,12.388,9.2q4.864,6.232,4.864,16.568a26.533,26.533,0,0,1-5.168,16.34A32.636,32.636,0,0,1,104.88-1.9,58.852,58.852,0,0,1,83.144,1.824Z"
                transform="translate(1051 594)"
                fill="#141414"
              />
              <path
                d="M76.912-58.064Q97.584-10.488,102.752,0h-19.3q-5.016-12.16-9.424-23.864L72.352-28.12q-7.9-.152-23.712-.152t-23.712.152Q18.544-12.16,14.136,0H-.152L6.232-14.9q3.344-8.056,15.124-35.872t20.292-49.1a3.974,3.974,0,0,1-2.736-2.28,6.85,6.85,0,0,1-.76-4.256H52.9q2.736,0,3.5,1.672ZM68.7-38.608,60.04-59.584q-.76-1.976-5.092-12.236t-6.46-16.8Q44.08-75.848,34.5-52.592,28.88-39.064,28.728-38.608Z"
                transform="translate(1182 594)"
                fill="#141414"
              />
              <path
                d="M13.376,0q.3-3.344.3-53.2t-.3-53.2h15.96q-.3,2.888-.3,47.12,0,37.544.152,47.728a48.361,48.361,0,0,0,11.1,1.216q33.9,0,39.976-.608V0Z"
                transform="translate(1285 594)"
                fill="#141414"
              />
              <path
                d="M13.376,0q.3-3.344.3-53.2t-.3-53.2h15.96q-.3,2.888-.3,47.12,0,37.544.152,47.728a48.361,48.361,0,0,0,11.1,1.216q33.9,0,39.976-.608V0Z"
                transform="translate(1366 594)"
                fill="#141414"
              />
              <path
                d="M41.8-10.488q11.4,0,24.624-.228t17.784-.532V0H13.376q.3-3.344.3-53.2t-.3-53.2h68.4v11.1q-15.5-.608-48.488-.608-3.648,0-4.1,1.976-.152,8.664-.152,33.9H36.48q11.4,0,34.808-.608V-49.1q-13.984-.456-42.256-.456,0,28.424.152,38Q32.832-10.488,41.8-10.488ZM54.568-111.872l-8.056-.152a2.1,2.1,0,0,1-1.368-.38,1.087,1.087,0,0,1-.456-.836,2.531,2.531,0,0,1,.912-1.672l20.52-14.744a31.643,31.643,0,0,1,4.712,1.824,16.875,16.875,0,0,1,4.1,2.584,1.752,1.752,0,0,1,.608,1.216q0,.912-1.52,1.824Z"
                transform="translate(1447 594)"
                fill="#141414"
              />
            </g>
          </svg>
        </div>
      </div>
      {children}
    </>
  )
}

export default Loaded
